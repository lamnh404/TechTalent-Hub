<%- include('../partials/header', { title: 'T√¨m vi·ªác l√†m IT' }) %>

<body class="animate-fade-in">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const jobContainer = document.getElementById('job-list-container');

            // L·∫Øng nghe s·ª± ki·ªán click v√†o b·∫•t k·ª≥ th·∫ª n√†o trong jobContainer
            jobContainer.addEventListener('click', function (e) {
                // Ki·ªÉm tra xem c√°i ƒë∆∞·ª£c click c√≥ ph·∫£i l√† n√∫t ph√¢n trang (.page-link) kh√¥ng
                const link = e.target.closest('.page-link');
                
                // N·∫øu ƒë√∫ng l√† link ph√¢n trang v√† kh√¥ng b·ªã disable
                if (link && !link.parentElement.classList.contains('disabled')) {
                    e.preventDefault(); // 1. Ch·∫∑n tr√¨nh duy·ªát reload trang
                    
                    const url = link.href; // L·∫•y ƒë∆∞·ªùng d·∫´n trang m·ªõi (VD: /jobs?page=2)

                    // Hi·ªáu ·ª©ng m·ªù ƒëi ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒëang t·∫£i
                    jobContainer.style.opacity = '0.5';
                    jobContainer.style.pointerEvents = 'none';

                    // 2. G·ªçi AJAX ƒë·ªÉ l·∫•y n·ªôi dung trang m·ªõi
                    fetch(url)
                        .then(response => response.text())
                        .then(html => {
                            // 3. Ph√¢n t√≠ch HTML tr·∫£ v·ªÅ
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            
                            // L·∫•y n·ªôi dung m·ªõi c·ªßa ph·∫ßn job-list-container
                            const newContent = doc.getElementById('job-list-container').innerHTML;

                            // 4. Thay th·∫ø n·ªôi dung c≈© b·∫±ng n·ªôi dung m·ªõi
                            jobContainer.innerHTML = newContent;
                            
                            // Kh√¥i ph·ª•c hi·ªáu ·ª©ng
                            jobContainer.style.opacity = '1';
                            jobContainer.style.pointerEvents = 'auto';

                            // 5. C·∫≠p nh·∫≠t URL tr√™n thanh ƒë·ªãa ch·ªâ m√† kh√¥ng reload
                            window.history.pushState({}, '', url);

                            // 6. Cu·ªôn nh·∫π l√™n ƒë·∫ßu danh s√°ch (thay v√¨ ƒë·∫ßu trang)
                            // Tr·ª´ ƒëi kho·∫£ng 100px ƒë·ªÉ kh√¥ng b·ªã che b·ªüi menu
                            const y = jobContainer.getBoundingClientRect().top + window.scrollY - 100;
                            window.scrollTo({top: y, behavior: 'smooth'});
                        })
                        .catch(err => {
                            console.error('L·ªói t·∫£i trang:', err);
                            jobContainer.style.opacity = '1';
                            jobContainer.style.pointerEvents = 'auto';
                            // N·∫øu l·ªói th√¨ fallback v·ªÅ reload th∆∞·ªùng
                            window.location.href = url;
                        });
                }
            });
        });
    </script>
    <%- include('../partials/navbar', {activePage: 'jobs' }) %>

    <section class="home-hero" style="padding: 140px 0 80px;">
        <div class="container position-relative" style="z-index: 2;">
            <div class="text-center">
                <span class="badge badge-pill badge-primary px-3 py-2 mb-3 animate__animated animate__fadeInDown">
                    üöÄ <%= (typeof pagination !== 'undefined' && pagination.totalJobs) ? pagination.totalJobs : '0' %> Jobs Available
                </span>
                <h1 class="hero-title mb-3 animate__animated animate__fadeInUp">Find Your Next <span class="text-primary">Tech Job</span></h1>

                <div class="search-wrapper animate__animated animate__fadeInUp animate__delay-1s mx-auto">
                    <form action="/jobs" method="GET" class="d-flex w-100 align-items-center">
                        <div class="flex-grow-1 position-relative">
                            <i class="fas fa-search position-absolute text-muted" style="left: 20px; top: 50%; transform: translateY(-50%); z-index: 5;"></i>
                            <input type="text" name="q" class="search-input" placeholder="Search jobs..." style="padding-left: 50px; width: 100%;" value="<%= typeof q !== 'undefined' ? q : '' %>">
                        </div>
                        <button type="submit" class="btn-search ml-2">Search</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section class="section bg-light pt-5 pb-5">
        <div class="container">
            <div class="row">

                <div class="col-lg-3 mb-4">
                    <div class="filter-card sticky-top" style="top: 100px; z-index: 1;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="font-weight-bold mb-0 text-dark"><i class="fas fa-filter mr-2 text-primary"></i>Filters</h6>
                            <a href="/jobs" class="small text-muted text-decoration-none">Reset</a>
                        </div>

                        <div class="mb-4">
                            <label class="small font-weight-bold text-muted text-uppercase mb-3">Job Type</label>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="typeFull">
                                <label class="custom-control-label text-dark" for="typeFull">Full-time</label>
                            </div>
                            <div class="custom-control custom-checkbox mb-2">
                                <input type="checkbox" class="custom-control-input" id="typeRemote">
                                <label class="custom-control-label text-dark" for="typeRemote">Remote</label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="small font-weight-bold text-muted text-uppercase mb-3">Location</label>
                            <select class="form-control-modern" style="height: 45px; padding-left: 15px;">
                                <option>All Locations</option>
                                <option>Ho Chi Minh</option>
                                <option>Ha Noi</option>
                            </select>
                        </div>

                        <button class="btn-primary-modern w-100">Apply Filters</button>
                    </div>
                </div>

                <div class="col-lg-9" id="job-list-container">
                    
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <p class="text-muted mb-0 small">Showing <strong><%= (typeof pagination !== 'undefined' && pagination.totalJobs) ? pagination.totalJobs : 0 %></strong> jobs</p>
                        <div class="dropdown">
                            <button class="btn btn-light border shadow-sm btn-sm dropdown-toggle" type="button" data-toggle="dropdown">Newest</button>
                            <div class="dropdown-menu dropdown-menu-right border-0 shadow-sm">
                                <a class="dropdown-item" href="#">Newest</a>
                                <a class="dropdown-item" href="#">Oldest</a>
                            </div>
                        </div>
                    </div>

                    <% if (typeof jobs !== 'undefined' && jobs && jobs.length > 0) { %>
                        <% jobs.forEach(job => { %>
                            <div class="job-card-horizontal mb-3 hover-scale">
                                <img src="<%= job.LogoURL ? job.LogoURL : '/images/default-company.png' %>" 
                                     alt="<%= job.CompanyName %>" 
                                     class="company-logo-sm"
                                     onerror="this.src='/images/default-company.png'"
                                     style="object-fit: contain; background: #fff;">
                                
                                <div class="flex-grow-1">
                                    <h5 class="font-weight-bold mb-1">
                                        <a href="/jobs/<%= job.JobID %>" class="text-dark text-decoration-none stretched-link">
                                            <%= job.JobTitle %>
                                        </a>
                                    </h5>
                                    <p class="text-muted small mb-2">
                                        <i class="far fa-building mr-1"></i><%= job.CompanyName %> &bull; 
                                        <i class="fas fa-map-marker-alt mr-1"></i><%= job.Location %>
                                    </p>
                                    <div>
                                        <span class="tag tag-fulltime"><%= job.EmploymentType %></span>
                                    </div>
                                </div>

                                <div class="text-md-right">
                                    <h5 class="text-primary font-weight-bold mb-1">
                                        $<%= job.SalaryMin ? job.SalaryMin.toLocaleString() : 'N/A' %> - 
                                        $<%= job.SalaryMax ? job.SalaryMax.toLocaleString() : 'N/A' %>
                                    </h5>
                                    <span class="text-muted small">
                                        Posted: <%= new Date(job.PostedDate).toLocaleDateString('vi-VN') %>
                                    </span>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="text-center py-5">
                            <div class="mb-3"><i class="fas fa-search fa-3x text-muted opacity-50"></i></div>
                            <h3>No jobs found</h3>
                            <p class="text-muted">Try adjusting your search criteria or clear filters.</p>
                            <a href="/jobs" class="btn btn-outline-primary mt-3">View All Jobs</a>
                        </div>
                    <% } %>

                    <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
                        <nav class="mt-5">
                            <ul class="pagination justify-content-center">

                                <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
                                    <a class="page-link border-0 shadow-sm rounded-pill px-3 mr-2"
                                       href="/jobs?q=<%= typeof q !== 'undefined' ? q : '' %>&page=<%= pagination.currentPage - 1 %>"
                                       tabindex="-1">
                                        <i class="fas fa-chevron-left mr-1"></i> Prev
                                    </a>
                                </li>

                                <% 
                                    let startPage = Math.max(1, pagination.currentPage - 2);
                                    let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
                                %>

                                <% for(let i = startPage; i <= endPage; i++) { %>
                                    <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                                        <a class="page-link border-0 shadow-sm rounded-circle mx-1 d-flex align-items-center justify-content-center"
                                           style="width: 40px; height: 40px;"
                                           href="/jobs?q=<%= typeof q !== 'undefined' ? q : '' %>&page=<%= i %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                <% } %>

                                <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
                                    <a class="page-link border-0 shadow-sm rounded-pill px-3 ml-2"
                                       href="/jobs?q=<%= typeof q !== 'undefined' ? q : '' %>&page=<%= pagination.currentPage + 1 %>">
                                        Next <i class="fas fa-chevron-right ml-1"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    <% } %>

                </div>
            </div>
        </div>
    </section>

    <%- include('../partials/footer') %>
</body>