<%- include('../partials/header', { title: 'TÃ¬m viá»‡c lÃ m IT' }) %>

<body class="animate-fade-in">
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const jobContainer = document.getElementById('job-list-container');

            if (jobContainer) {
                jobContainer.addEventListener('click', function (e) {
                    const link = e.target.closest('.page-link');
                    if (link && !link.parentElement.classList.contains('disabled')) {
                        e.preventDefault();
                        const url = link.href;

                        // Hiá»‡u á»©ng má» khi táº£i
                        jobContainer.style.opacity = '0.5';
                        jobContainer.style.pointerEvents = 'none';

                        fetch(url)
                            .then(response => response.text())
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const newContent = doc.getElementById('job-list-container').innerHTML;

                                jobContainer.innerHTML = newContent;
                                jobContainer.style.opacity = '1';
                                jobContainer.style.pointerEvents = 'auto';

                                window.history.pushState({}, '', url);
                                
                                // Cuá»™n lÃªn Ä‘áº§u danh sÃ¡ch nháº¹ nhÃ ng
                                const y = jobContainer.getBoundingClientRect().top + window.scrollY - 100;
                                window.scrollTo({top: y, behavior: 'smooth'});
                            })
                            .catch(err => {
                                console.error('Lá»—i táº£i trang:', err);
                                window.location.href = url; // Fallback náº¿u lá»—i
                            });
                    }
                });
            }
        });
    </script>

    <%- include('../partials/navbar', {activePage: 'jobs' }) %>

    <section class="home-hero" style="padding: 140px 0 80px;">
        <div class="container position-relative" style="z-index: 2;">
            <div class="text-center">
                <span class="badge badge-pill badge-primary px-3 py-2 mb-3 animate__animated animate__fadeInDown">
                    ðŸš€ <%= (typeof pagination !== 'undefined' && pagination.totalJobs) ? pagination.totalJobs : '0' %> Jobs Available
                </span>
                <h1 class="hero-title mb-3 animate__animated animate__fadeInUp">Find Your Next <span class="text-primary">Tech Job</span></h1>

                <div class="search-wrapper animate__animated animate__fadeInUp animate__delay-1s mx-auto">
                    <form action="/jobs" method="GET" class="d-flex w-100 align-items-center">
                        <div class="flex-grow-1 position-relative">
                            <i class="fas fa-search position-absolute text-muted" style="left: 20px; top: 50%; transform: translateY(-50%); z-index: 5;"></i>
                            <input type="text" name="q" class="search-input" placeholder="Search jobs..." style="padding-left: 50px; width: 100%;" value="<%= typeof q !== 'undefined' ? q : '' %>">
                        </div>
                        <button type="submit" class="btn-search ml-2">Search</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section class="section bg-light pt-5 pb-5">
        <div class="container">
            <div class="row justify-content-center">

                <div class="col-lg-10" id="job-list-container">
                    
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <p class="text-muted mb-0 small">Showing <strong><%= (typeof pagination !== 'undefined' && pagination.totalJobs) ? pagination.totalJobs : 0 %></strong> jobs</p>
                        <div class="dropdown">
                            <button class="btn btn-light border shadow-sm btn-sm dropdown-toggle" type="button" data-toggle="dropdown">Newest</button>
                            <div class="dropdown-menu dropdown-menu-right border-0 shadow-sm">
                                <a class="dropdown-item" href="#">Newest</a>
                                <a class="dropdown-item" href="#">Oldest</a>
                            </div>
                        </div>
                    </div>

                    <% if (typeof jobs !== 'undefined' && jobs && jobs.length > 0) { %>
                        <% jobs.forEach(job => { %>
                            <div class="job-card-horizontal mb-3 hover-scale">
                                <img src="<%= job.LogoURL ? job.LogoURL : '/images/default-company.png' %>" 
                                     alt="<%= job.CompanyName %>" 
                                     class="company-logo-sm"
                                     onerror="this.src='/images/default-company.png'"
                                     style="object-fit: contain; background: #fff;">
                                
                                <div class="flex-grow-1">
                                    <h5 class="font-weight-bold mb-1">
                                        <a href="/jobs/<%= job.JobID %>" class="text-dark text-decoration-none stretched-link">
                                            <%= job.JobTitle %>
                                        </a>
                                    </h5>
                                    <p class="text-muted small mb-2">
                                        <i class="far fa-building mr-1"></i><%= job.CompanyName %> &bull; 
                                        <i class="fas fa-map-marker-alt mr-1"></i><%= job.Location %>
                                    </p>
                                    <div>
                                        <span class="tag tag-fulltime"><%= job.EmploymentType %></span>
                                    </div>
                                </div>

                                <div class="text-md-right">
                                    <h5 class="text-primary font-weight-bold mb-1">
                                        $<%= job.SalaryMin ? job.SalaryMin.toLocaleString() : 'N/A' %> - 
                                        $<%= job.SalaryMax ? job.SalaryMax.toLocaleString() : 'N/A' %>
                                    </h5>
                                    <span class="text-muted small">
                                        Posted: <%= new Date(job.PostedDate).toLocaleDateString('vi-VN') %>
                                    </span>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="text-center py-5">
                            <div class="mb-3"><i class="fas fa-search fa-3x text-muted opacity-50"></i></div>
                            <h3>No jobs found</h3>
                            <p class="text-muted">Try adjusting your search criteria.</p>
                            <a href="/jobs" class="btn btn-outline-primary mt-3">View All Jobs</a>
                        </div>
                    <% } %>

                    <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
                        <nav class="mt-5">
                            <ul class="pagination justify-content-center">

                                <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
                                    <a class="page-link border-0 shadow-sm rounded-pill px-3 mr-2"
                                       href="/jobs?q=<%= typeof q !== 'undefined' ? q : '' %>&page=<%= pagination.currentPage - 1 %>">
                                        <i class="fas fa-chevron-left mr-1"></i> Prev
                                    </a>
                                </li>

                                <% 
                                    let startPage = Math.max(1, pagination.currentPage - 2);
                                    let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
                                %>

                                <% for(let i = startPage; i <= endPage; i++) { %>
                                    <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                                        <a class="page-link border-0 shadow-sm rounded-circle mx-1 d-flex align-items-center justify-content-center"
                                           style="width: 40px; height: 40px;"
                                           href="/jobs?q=<%= typeof q !== 'undefined' ? q : '' %>&page=<%= i %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                <% } %>

                                <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
                                    <a class="page-link border-0 shadow-sm rounded-pill px-3 ml-2"
                                       href="/jobs?q=<%= typeof q !== 'undefined' ? q : '' %>&page=<%= pagination.currentPage + 1 %>">
                                        Next <i class="fas fa-chevron-right ml-1"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    <% } %>

                </div>
            </div>
        </div>
    </section>

    <%- include('../partials/footer') %>
</body>