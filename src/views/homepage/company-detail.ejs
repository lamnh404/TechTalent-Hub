<%# Server phải luôn truyền company, openJobs, reviews từ database %>

<%- include('../partials/header', { title: company.CompanyName }) %>

<style>
    body {
        background-color: #f0f2f5;
    }

    /* --- HEADER CONTAINER (Scroll với trang) --- */
    .profile-header-sticky {
        background: rgba(255, 255, 255, 0.98);
        border-bottom: 1px solid #e4e6eb;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        
        /* Bỏ sticky - để scroll theo trang */
        position: relative;
        z-index: 99;
        
        /* Padding */
        padding-top: 25px;
    }

    .header-content {
        display: flex;
        align-items: flex-start;
        padding-bottom: 15px;
    }

    /* Avatar Box */
    .profile-logo {
        width: 120px;
        height: 120px;
        background: #fff;
        padding: 5px;
        border-radius: 16px;
        border: 1px solid #e4e6eb;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        object-fit: contain;
        flex-shrink: 0;
    }

    /* Info Area */
    .profile-info {
        margin-left: 24px;
        flex-grow: 1;
        padding-top: 5px;
        overflow: hidden; /* Tránh tràn layout khi animation */
    }

    .profile-title {
        font-size: 2rem;
        font-weight: 800;
        color: #1c1e21;
        margin-bottom: 8px;
        line-height: 1.1;
    }

    .profile-meta {
        color: #65676b;
        font-size: 0.95rem;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }
    
    .profile-meta span { display: flex; align-items: center; }
    .profile-meta i { margin-right: 6px; color: #888; }

    .profile-actions {
        margin-left: auto;
    }

    /* --- Tabs --- */
    .profile-tabs {
        display: flex;
        border-top: 1px solid #f0f2f5;
        margin-top: 0;
    }

    .profile-tab-link {
        padding: 15px 25px;
        font-weight: 600;
        color: #65676b;
        text-decoration: none;
        border-bottom: 3px solid transparent;
        transition: color 0.2s, background-color 0.2s, border-color 0.2s;
        cursor: pointer;
        display: flex;
        align-items: center;
        background: none;
        border-top: none;
        border-left: none;
        border-right: none;
    }

    .profile-tab-link:hover {
        background-color: #f2f2f2;
        color: #1c1e21;
        text-decoration: none;
    }

    .profile-tab-link.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    /* --- Content Section --- */
    .content-section { padding: 25px 0; min-height: 600px; }
    
    .info-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        border: 1px solid #e4e6eb;
        overflow: hidden;
    }
    .info-card-header { padding: 15px 20px; border-bottom: 1px solid #f0f2f5; font-weight: 700; font-size: 1.1rem; color: #1c1e21; }
    .info-card-body { padding: 20px; }

    /* Job Item */
    .job-item-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 20px; border-bottom: 1px solid #f0f2f5; transition: background 0.2s;
    }
    .job-item-row:last-child { border-bottom: none; }
    .job-item-row:hover { background: #fafafa; }

    /* Review Item */
    .review-item-row { padding: 20px; border-bottom: 1px solid #f0f2f5; }
    .review-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid #e4e6eb; }

    /* Responsive Mobile */
    @media (max-width: 991px) {
        .header-content { flex-direction: column; align-items: center; text-align: center; }
        .profile-info { margin-left: 0; margin-top: 15px; width: 100%; }
        .profile-meta { justify-content: center; }
        .header-actions { margin-top: 15px; margin-left: 0; }
        .profile-tabs { justify-content: center; overflow-x: auto; }
    }
</style>

<body>
    <%- include('../partials/navbar', {activePage: 'companies'}) %>

    <div class="animate-fade-in" id="mainWrapper">
        <div class="company-cover"></div>

        <div class="profile-header-sticky" id="stickyHeader">
            <div class="container">
                
                <div class="header-content">
                    <img src="<%= company.LogoURL || '/images/default-company.png' %>" 
                         alt="<%= company.CompanyName %>" 
                         class="profile-logo">
                    
                    <div class="profile-info">
                        <div>
                            <h1 class="profile-title"><%= company.CompanyName %> <i class="fas fa-check-circle text-primary small" style="font-size: 1rem;" title="Verified"></i></h1>
                            
                            <div class="profile-meta">
                                <% if (company.Industry) { %><span><i class="fas fa-industry"></i> <%= company.Industry %></span><% } %>
                                <% if (company.CompanyAddress) { %><span><i class="fas fa-map-marker-alt"></i> <%= company.CompanyAddress %></span><% } %>
                                <% if (company.CompanySize) { %><span><i class="fas fa-users"></i> <%= company.CompanySize %></span><% } %>
                                <% if (company.FoundedYear) { %><span><i class="far fa-calendar-alt"></i> Est. <%= company.FoundedYear %></span><% } %>
                            </div>
                        </div>
                    </div>

                    <div class="profile-actions">
                        <% if (company.CompanyWebsite) { %>
                            <a href="<%= company.CompanyWebsite %>" target="_blank" class="btn btn-light border shadow-sm font-weight-bold">
                                <i class="fas fa-globe mr-2"></i> Website
                            </a>
                        <% } %>
                    </div>
                </div>

                <div class="profile-tabs">
                    <button class="profile-tab-link active" data-target="#about">About</button>
                    <button class="profile-tab-link" data-target="#jobs">
                        Jobs <span class="badge badge-light border ml-2"><%= openJobs.length %></span>
                    </button>
                    <button class="profile-tab-link" data-target="#reviews">
                        Reviews <span class="badge badge-light border ml-2"><%= reviews.length %></span>
                    </button>
                </div>

            </div>
        </div>

        <div class="container content-section">
            <div class="row">
                
                <div class="col-lg-8">
                    <div class="tab-content">
                        
                        <div class="tab-pane fade show active" id="about">
                            <div class="info-card">
                                <div class="info-card-header">Overview</div>
                                <div class="info-card-body text-secondary" style="line-height: 1.8;">
                                    <p><%= company.CompanyDescription || company.Description || 'No description available.' %></p>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="jobs">
                            <div class="info-card">
                                <div class="info-card-header d-flex justify-content-between align-items-center">
                                    <span>Open Positions</span>
                                    <span class="badge badge-soft-primary"><%= openJobs.length %> Available</span>
                                </div>
                                <div class="p-0">
                                    <% if (openJobs && openJobs.length > 0) { %>
                                        <% openJobs.forEach(job => { %>
                                            <div class="job-item-row">
                                                <div>
                                                    <h6 class="font-weight-bold mb-1">
                                                        <a href="/jobs/<%= job.JobID %>" class="text-dark text-decoration-none hover-primary"><%= job.JobTitle %></a>
                                                    </h6>
                                                    <div class="text-muted small">
                                                        <span class="mr-3"><i class="fas fa-map-marker-alt"></i> <%= job.Location %></span>
                                                        <span class="mr-3"><i class="fas fa-briefcase"></i> <%= job.Type || job.EmploymentType %></span>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="font-weight-bold text-success mb-1"><%= job.Salary %></div>
                                                    <a href="/jobs/<%= job.JobID %>" class="btn btn-outline-primary btn-sm rounded-pill px-4 font-weight-bold">Apply</a>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <div class="text-center py-5 text-muted">
                                            <i class="fas fa-briefcase fa-2x mb-3 opacity-25"></i>
                                            <p>No open positions right now.</p>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="reviews">
                            
                            <% if (typeof user !== 'undefined' && user && user.userType === 'JobSeeker') { %>
                                <div class="info-card bg-soft-primary border-0 mb-4">
                                    <div class="info-card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="font-weight-bold text-primary mb-0">Have you worked here?</h6>
                                            <button class="btn btn-sm btn-primary shadow-sm" type="button" data-toggle="collapse" data-target="#reviewForm">
                                                Write a Review
                                            </button>
                                        </div>
                                        <div class="collapse mt-3" id="reviewForm">
                                            <form action="/companies/<%= company.CompanyID %>/review" method="POST">
                                                
                                                <div class="form-group mb-2">
                                                    <label class="small font-weight-bold">Your Rating</label>
                                                    <div class="star-rating-input">
                                                        <input type="radio" id="s5" name="rating" value="5" required><label for="s5">★</label>
                                                        <input type="radio" id="s4" name="rating" value="4"><label for="s4">★</label>
                                                        <input type="radio" id="s3" name="rating" value="3"><label for="s3">★</label>
                                                        <input type="radio" id="s2" name="rating" value="2"><label for="s2">★</label>
                                                        <input type="radio" id="s1" name="rating" value="1"><label for="s1">★</label>
                                                    </div>
                                                </div>

                                                <div class="form-group mb-2">
                                                    <input type="text" class="form-control" name="title" placeholder="Review Title (e.g. Great place to learn)" required>
                                                </div>
                                                <div class="form-group mb-2">
                                                    <textarea class="form-control" name="content" rows="3" placeholder="Share your experience..." required></textarea>
                                                </div>
                                                <div class="custom-control custom-checkbox mb-3">
                                                    <input type="checkbox" class="custom-control-input" id="anonCheck" name="isAnonymous">
                                                    <label class="custom-control-label small" for="anonCheck">Post anonymously</label>
                                                </div>
                                                <button class="btn btn-primary btn-sm">Submit Review</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            <% } %>

                            <div class="info-card">
                                <div class="info-card-header">Employee Reviews</div>
                                <div class="p-0">
                                    <% if (reviews && reviews.length > 0) { %>
                                        <% reviews.forEach(review => { %>
                                            <div class="review-item-row">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <div class="d-flex align-items-center">
                                                        <img src="<%= review.ReviewerAvatar %>" class="review-avatar mr-3">
                                                        <div>
                                                            <h6 class="font-weight-bold mb-0 text-dark"><%= review.ReviewerName %></h6>
                                                            <small class="text-muted"><%= new Date(review.ReviewDate).toLocaleDateString() %></small>
                                                        </div>
                                                    </div>
                                                    <div class="star-display text-warning small">
                                                        <% for(let i=1; i<=5; i++) { %>
                                                            <i class="fas fa-star <%= i <= review.Rating ? 'filled' : 'text-muted opacity-25' %>"></i>
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <h6 class="font-weight-bold mt-2"><%= review.ReviewTitle %></h6>
                                                <p class="text-muted mb-0"><%= review.ReviewText %></p>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <div class="text-center py-5 text-muted">
                                            <i class="far fa-comment-dots fa-2x mb-2 opacity-50"></i>
                                            <p class="mb-0">No reviews yet.</p>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="info-card">
                        <div class="info-card-header">Contact Info</div>
                        <div class="info-card-body">
                            <ul class="list-unstyled mb-0">
                                <% if (company.CompanyAddress) { %>
                                <li class="mb-3 d-flex">
                                    <i class="fas fa-map-marker-alt text-muted mt-1 mr-3" style="width: 20px;"></i>
                                    <span class="text-dark"><%= company.CompanyAddress %></span>
                                </li>
                                <% } %>
                                <% if (company.CompanyWebsite) { %>
                                <li class="mb-3 d-flex">
                                    <i class="fas fa-globe text-muted mt-1 mr-3" style="width: 20px;"></i>
                                    <a href="<%= company.CompanyWebsite %>" target="_blank" class="text-primary text-truncate"><%= company.CompanyWebsite %></a>
                                </li>
                                <% } %>
                            </ul>
                            <hr class="my-3 opacity-50">
                            <h6 class="font-weight-bold small text-uppercase text-muted mb-3">Social Profiles</h6>
                            <div class="d-flex gap-2">
                                <a href="#" class="btn btn-light btn-sm flex-grow-1"><i class="fab fa-facebook-f text-primary"></i></a>
                                <a href="#" class="btn btn-light btn-sm flex-grow-1"><i class="fab fa-linkedin-in text-info"></i></a>
                                <a href="#" class="btn btn-light btn-sm flex-grow-1"><i class="fab fa-twitter text-info"></i></a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <%- include('../partials/footer') %>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab Handling
            const tabButtons = document.querySelectorAll('.profile-tab-link');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('data-target');
                    
                    // Update Buttons
                    tabButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Update Content (Using Bootstrap's jQuery if available, else manual)
                    if (typeof $ !== 'undefined' && $.fn.tab) {
                        $(this).tab('show'); // Bootstrap 4 API
                        // Also show the tab content manually just in case
                        $('.tab-pane').removeClass('show active');
                        $(targetId).addClass('show active');
                    } else {
                        // Pure JS Fallback
                        document.querySelectorAll('.tab-pane').forEach(p => {
                            p.classList.remove('show', 'active');
                            p.style.display = 'none';
                        });
                        const target = document.querySelector(targetId);
                        if (target) {
                            target.classList.add('show', 'active');
                            target.style.display = 'block';
                            // Small timeout to allow display:block to apply before opacity transition
                            setTimeout(() => target.style.opacity = 1, 10);
                        }
                    }
                });
            });
        });
    </script>
</body>