<% let currentUser=null; let currentRole='guest' ; let displayName='Guest' ; let userAvatar='/images/default-avatar.png'
    ; if (typeof user !=='undefined' && user) { currentUser=user; currentRole=user.userType || 'guest' ;
    displayName=user.name || (user.email ? user.email.split('@')[0] : 'User' ); if (user.avatarUrl) {
    userAvatar=user.avatarUrl; } } %>

    <nav class="navbar navbar-expand-lg navbar-light fixed-top navbar-glass">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="/images/logo.svg" alt="Logo" width="30" height="30" class="d-inline-block align-top mr-2">
                <span class="brand-name-main">TechTalent</span><span class="brand-name-accent">Hub</span>
            </a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto align-items-center">

                    <% if (!currentUser) { %>
                        <li class="nav-item">
                            <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'home') ? 'active' : '' %>"
                                href="/">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'jobs') ? 'active' : '' %>"
                                href="/jobs">Find Jobs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'companies') ? 'active' : '' %>"
                                href="/companies">Companies</a>
                        </li>
                        <li class="nav-item ml-3">
                            <a class="nav-link font-weight-bold" href="/login">Sign In</a>
                        </li>
                        <li class="nav-item ml-2">
                            <a class="btn btn-primary btn-sm px-4 rounded-pill shadow-sm" href="/register">Sign Up</a>
                        </li>
                        <% } else { %>

                            <% if (currentRole==='JobSeeker' ) { %>
                                <li class="nav-item">
                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'jobs') ? 'active' : '' %>"
                                        href="/jobs"><i class="fas fa-search mr-1"></i> Find Jobs</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'applications') ? 'active' : '' %>"
                                        href="/seeker/applications"><i class="fas fa-file-alt mr-1"></i>
                                        Applications</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'suggestions') ? 'active' : '' %>"
                                        href="/seeker/suggestions"><i class="fas fa-file-alt mr-1"></i>
                                        Job Suggestions</a>
                                </li>
                                <% } %>

                                    <% if (currentRole==='Company' ) { %>
                                        <li class="nav-item">
                                            <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'dashboard') ? 'active' : '' %>"
                                                href="/company/dashboard">Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'manage-jobs') ? 'active' : '' %>"
                                                href="/company/jobs">Manage Jobs</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'find-candidates') ? 'active' : '' %>"
                                                href="/company/candidates">Candidates</a>
                                        </li>
                                        <li class="nav-item ml-2">
                                            <a class="btn btn-primary btn-sm px-3 shadow-sm"
                                                href="/company/jobs/create">
                                                <i class="fas fa-plus mr-1"></i> Post a Job
                                            </a>
                                        </li>
                                        <% } %>

                                            <% if (currentRole==='Admin' || currentRole==='admin' ) { %>
                                                <li class="nav-item">
                                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'dashboard') ? 'active' : '' %>"
                                                        href="/admin/dashboard">Dashboard</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'users') ? 'active' : '' %>"
                                                        href="/admin/users">Users</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'admin-jobs') ? 'active' : '' %>"
                                                        href="/admin/jobs">Jobs</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link <%= (typeof activePage !== 'undefined' && activePage === 'settings') ? 'active' : '' %>"
                                                        href="/admin/settings">System</a>
                                                </li>
                                                <% } %>

                                                    <li class="nav-item dropdown mx-3">
                                                        <a class="nav-link position-relative text-dark" href="#"
                                                            id="notiDropdown" role="button" data-toggle="dropdown"
                                                            aria-haspopup="true" aria-expanded="false">
                                                            <i class="far fa-bell" style="font-size: 1.2rem;"></i>
                                                            <span
                                                                class="badge badge-danger badge-pill position-absolute"
                                                                id="notiBadge"
                                                                style="top: -2px; right: -2px; font-size: 0.6rem; display: none;">0</span>
                                                        </a>
                                                        <div class="dropdown-menu dropdown-menu-right shadow-lg mt-2 animate__animated animate__fadeIn notification-menu"
                                                            style="width: 360px; max-height: 460px; overflow-y: auto;"
                                                            aria-labelledby="notiDropdown">

                                                            <div
                                                                class="px-3 py-2 border-bottom d-flex justify-content-between align-items-center bg-light sticky-top">
                                                                <h6
                                                                    class="font-weight-bold mb-0 small text-uppercase text-muted">
                                                                    Notifications</h6>
                                                                <small class="text-muted" id="notiCountText">0
                                                                    new</small>
                                                            </div>

                                                            <div id="notiList">
                                                                <div class="text-center py-4 text-muted small">
                                                                    <i
                                                                        class="fas fa-spinner fa-spin mb-2"></i><br>Loading...
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>

                                                    <li class="nav-item dropdown">
                                                        <a class="nav-link dropdown-toggle d-flex align-items-center"
                                                            href="#" id="userDropdown" role="button"
                                                            data-toggle="dropdown">
                                                            <img src="<%= userAvatar %>" alt="Avatar"
                                                                class="rounded-circle mr-2 shadow-sm" width="32"
                                                                height="32"
                                                                style="object-fit: cover; border: 2px solid #fff;">
                                                            <span class="font-weight-bold text-dark d-none d-lg-inline">
                                                                <%= displayName %>
                                                            </span>
                                                        </a>
                                                        <div
                                                            class="dropdown-menu dropdown-menu-right border-0 shadow-lg mt-2 animate__animated animate__fadeIn">
                                                            <div
                                                                class="px-3 py-3 bg-light border-bottom mb-2 rounded-top">
                                                                <p
                                                                    class="mb-0 text-muted small text-uppercase font-weight-bold">
                                                                    <%= currentRole %>
                                                                </p>
                                                                <p class="mb-0 font-weight-bold text-truncate"
                                                                    style="max-width: 200px;">
                                                                    <%= currentUser.email %>
                                                                </p>
                                                            </div>

                                                            <% if (currentRole==='JobSeeker' ) { %>
                                                                <a class="dropdown-item" href="/seeker/profile"><i
                                                                        class="far fa-id-card mr-2 text-muted"></i> My
                                                                    Profile</a>
                                                                <% } else if (currentRole==='Company' ) { %>
                                                                    <a class="dropdown-item" href="/company/profile"><i
                                                                            class="far fa-building mr-2 text-muted"></i>
                                                                        Company Profile</a>
                                                                    <% } %>

                                                                        <a class="dropdown-item" href="/settings"><i
                                                                                class="fas fa-cog mr-2 text-muted"></i>
                                                                            Settings</a>
                                                                        <div class="dropdown-divider"></div>
                                                                        <a class="dropdown-item text-danger font-weight-bold"
                                                                            href="/auth/logout"><i
                                                                                class="fas fa-sign-out-alt mr-2"></i>
                                                                            Logout</a>
                                                        </div>
                                                    </li>
                                                    <% } %>

                </ul>
            </div>
        </div>
    </nav>

    <% if (currentUser) { %>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const notiList = document.getElementById('notiList');
                const notiBadge = document.getElementById('notiBadge');
                const notiCountText = document.getElementById('notiCountText');

                // 1. Hàm tải thông báo
                async function fetchNotifications() {
                    try {
                        const response = await fetch('/api/notifications');
                        if (!response.ok) throw new Error('Failed to load');

                        const data = await response.json();
                        const notifications = data.notifications || [];
                        renderNotifications(notifications);
                    } catch (error) {
                        console.error("Error fetching notifications:", error);
                        // Mock Data fallback
                        renderMockData();
                    }
                }

                // 2. Hàm Render
                function renderNotifications(notifications) {
                    if (notifications.length === 0) {
                        notiList.innerHTML = '<div class="text-center py-4 text-muted small">You have no new notifications.</div>';
                        notiBadge.style.display = 'none';
                        notiCountText.innerText = '0 new';
                        return;
                    }

                    const unreadCount = notifications.filter(n => !n.ReadStatus).length;
                    if (unreadCount > 0) {
                        notiBadge.innerText = unreadCount;
                        notiBadge.style.display = 'inline-block';
                        notiCountText.innerText = `${unreadCount} new`;
                    } else {
                        notiBadge.style.display = 'none';
                        notiCountText.innerText = 'All caught up';
                    }

                    let html = '';
                    notifications.forEach(n => {
                        const date = new Date(n.SendDate).toLocaleDateString('vi-VN');

                        let icon = 'fa-info-circle text-info';
                        if (n.NotificationType === 'Application') icon = 'fa-briefcase text-primary';
                        if (n.NotificationType === 'System') icon = 'fa-cog text-secondary';
                        if (n.NotificationType === 'Rejection') icon = 'fa-times-circle text-danger';
                        if (n.NotificationType === 'Interview') icon = 'fa-calendar-check text-success';

                        const bgClass = n.ReadStatus ? '' : 'notification-unread';

                        html += `
                    <div class="notification-item ${bgClass}" id="noti-${n.NotificationID}">
    <div class="notification-icon-wrapper">
        <i class="fas ${icon}"></i>
    </div>

    <div class="notification-content">
        <p class="mb-1 small" style="line-height: 1.4;">
            ${n.NotificationContent}
        </p>
        <div class="notification-time">${date}</div>
    </div>

    <button class="btn p-0 notification-delete-btn" onclick="deleteNotification(event, ${n.NotificationID})">
        <i class="fas fa-times"></i>
    </button>
</div>

                `;
                    });
                    notiList.innerHTML = html;
                }

                // 3. Hàm xóa
                window.deleteNotification = async function (event, id) {
                    event.preventDefault();
                    event.stopPropagation();
                    if (!confirm('Delete this notification?')) return;

                    try {
                        // Gọi API xóa thật (Giả lập)
                        // await fetch(`/api/notifications/${id}`, { method: 'DELETE' });

                        // Xóa UI
                        const el = document.getElementById(`noti-${id}`);
                        if (el) {
                            el.style.opacity = '0';
                            setTimeout(() => {
                                el.remove();
                                let current = parseInt(notiBadge.innerText) || 0;
                                if (current > 0) {
                                    notiBadge.innerText = current - 1;
                                    if (current - 1 === 0) notiBadge.style.display = 'none';
                                }
                                if (notiList.children.length === 0) {
                                    notiList.innerHTML = '<div class="text-center py-4 text-muted small">You have no new notifications.</div>';
                                }
                            }, 300);
                        }
                    } catch (err) {
                        console.error("Delete failed", err);
                    }
                }

                // Fallback Mock Data
                function renderMockData() {
                    const mockData = [
                        { NotificationID: 1, NotificationType: 'Application', NotificationContent: 'Nguyen Van A applied for Senior React Dev.', SendDate: new Date(), ReadStatus: false },
                        { NotificationID: 2, NotificationType: 'System', NotificationContent: 'Your profile has been verified.', SendDate: new Date(Date.now() - 86400000), ReadStatus: true }
                    ];
                    renderNotifications(mockData);
                }

                // Chạy
                // fetchNotifications();
                renderMockData();
            });
        </script>
        <% } %>