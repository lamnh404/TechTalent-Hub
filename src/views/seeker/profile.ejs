<%# Server phải truyền seeker và availableSkills từ database %>

<%- include('../partials/header', { title: 'My Profile' }) %>

<body class="dashboard-page">
    <div class="dashboard-wrapper">
        <%- include('../partials/navbar', { activePage: 'profile' }) %>

        <main class="main-content">
            <header class="dashboard-header">
                <h5 class="mb-0 font-weight-bold text-dark">My Profile</h5>
            </header>

            <div class="p-4">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        
                        <div class="card border-0 shadow-sm rounded-lg mb-4">
                            <div class="card-body p-5">
                                <h5 class="font-weight-bold text-primary mb-4">Personal Information</h5>
                                <hr class="mb-4">
                                
                                <form action="/seeker/profile/update" method="POST" id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">First Name</label>
                                            <input type="text" class="form-control-modern" name="FirstName" value="<%= seeker.FirstName %>">
                                            <small class="text-danger required-error d-none mt-1">First name is required</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">Last Name</label>
                                            <input type="text" class="form-control-modern" name="LastName" value="<%= seeker.LastName %>">
                                            <small class="text-danger required-error d-none mt-1">Last name is required</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">Email</label>
                                            <input type="email" class="form-control-modern" value="<%= seeker.Email %>" disabled style="background-color: #f8f9fa;">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">Phone</label>
                                            <input type="tel" class="form-control-modern" name="PhoneNumber" value="<%= seeker.PhoneNumber %>">
                                            <small class="text-danger required-error d-none mt-1">Phone number is required</small>
                                            <small class="text-danger phone-invalid-error d-none mt-1">Invalid phone number (10-11 digits)</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">Experience Level</label>
                                            <input type="text" class="form-control-modern" name="ExperienceLevel" value="<%= seeker.ExperienceLevel || '' %>">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">Location</label>
                                            <input type="text" class="form-control-modern" name="CurrentLocation" value="<%= seeker.CurrentLocation %>">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="font-weight-bold small text-dark">Date of Birth</label>
                                            <input type="date" class="form-control-modern" name="DateOfBirth" value="<% if (seeker.DateOfBirth) { const d = new Date(seeker.DateOfBirth); const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); %><%= `${yyyy}-${mm}-${dd}` %><% } %>">
                                            <small class="text-danger required-error d-none mt-1">Date of birth is required</small>
                                            <small class="text-danger dob-invalid-error d-none mt-1">Invalid date (must be at least 15 years old)</small>
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="font-weight-bold small text-dark">Summary</label>
                                        <textarea class="form-control-modern h-auto py-3" name="ProfileSummary" rows="3"><%= seeker.ProfileSummary %></textarea>
                                    </div>
                                    
                                    <input type="hidden" name="Skills" id="skillsInput" value='<%= JSON.stringify(seeker.Skills) %>'>
                                    
                                    <div class="text-right mt-4">
                                        <button type="submit" class="btn btn-primary-modern px-4 shadow-sm font-weight-bold">
                                            <i class="fas fa-save mr-2"></i> Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm rounded-lg mb-4">
                            <div class="card-body p-5">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="font-weight-bold text-primary mb-0">Professional Skills</h5>
                                    <div class="d-flex align-items-center">
                                        <div class="mr-3 text-right d-none d-sm-block">
                                            <small class="text-muted">Total Skill Score</small>
                                            <div><strong id="totalSkillScore"><%= typeof totalSkillScore !== 'undefined' ? totalSkillScore : 0 %></strong></div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill font-weight-bold" data-toggle="modal" data-target="#addSkillModal">
                                            <i class="fas fa-plus mr-1"></i> Add Skill
                                        </button>
                                    </div>
                                </div>
                                <hr class="mb-4">

                                <div id="skillsContainer" class="d-flex flex-wrap gap-2">
                                    </div>
                                
                                <div id="noSkillsMsg" class="text-center text-muted py-3" style="display: none;">
                                    <small>No skills added yet.</small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="addSkillModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-0 shadow-lg rounded-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title font-weight-bold">Add New Skill</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <form id="skillForm">
                        <div class="form-group mb-3">
                            <label class="small font-weight-bold text-dark">Select Skill</label>
                            <div class="input-wrapper">
                                <i class="fas fa-code input-icon"></i>
                                <input type="text" class="form-control-modern" list="availableSkillsList" id="skillNameInput" placeholder="Type to search..." autocomplete="off">
                                <datalist id="availableSkillsList">
                                    <% availableSkills.forEach(s => { %>
                                        <option value="<%= s.SkillName %>"></option>
                                    <% }) %>
                                </datalist>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="small font-weight-bold text-dark">Proficiency</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-layer-group input-icon"></i>
                                    <select class="form-control-modern" id="skillLevelInput">
                                        <option value="Beginner">Beginner</option>
                                        <option value="Intermediate" selected>Intermediate</option>
                                        <option value="Advanced">Advanced</option>
                                        <option value="Expert">Expert</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="small font-weight-bold text-dark">Experience (Years)</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-history input-icon"></i>
                                    <input type="number" class="form-control-modern" id="skillExpInput" value="1" min="0" step="0.5">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 bg-light rounded-bottom p-3">
                    <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-modern shadow-sm" id="saveSkillBtn">Add</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        (function() {
            const profileForm = document.getElementById('profileForm');
            if (!profileForm) return;

            const firstName = profileForm.querySelector('input[name="FirstName"]');
            const lastName = profileForm.querySelector('input[name="LastName"]');
            const phone = profileForm.querySelector('input[name="PhoneNumber"]');
            const dob = profileForm.querySelector('input[name="DateOfBirth"]');

            const phoneRegex = /^(0|\+84)\d{9,10}$/;

            function show(el) { if (el) el.classList.remove('d-none'); }
            function hide(el) { if (el) el.classList.add('d-none'); }

            function validateProfile() {
                let ok = true;

                const fnMsg = firstName ? firstName.parentElement.querySelector('.required-error') : null;
                if (!firstName || !firstName.value.trim()) { show(fnMsg); firstName && firstName.classList.add('is-invalid'); ok = false; } else { hide(fnMsg); firstName && firstName.classList.remove('is-invalid'); }

                const lnMsg = lastName ? lastName.parentElement.querySelector('.required-error') : null;
                if (!lastName || !lastName.value.trim()) { show(lnMsg); lastName && lastName.classList.add('is-invalid'); ok = false; } else { hide(lnMsg); lastName && lastName.classList.remove('is-invalid'); }

                const phoneReq = phone ? phone.parentElement.querySelector('.required-error') : null;
                const phoneInvalid = phone ? phone.parentElement.querySelector('.phone-invalid-error') : null;
                if (!phone || !phone.value.trim()) { show(phoneReq); hide(phoneInvalid); phone && phone.classList.add('is-invalid'); ok = false; }
                else {
                    hide(phoneReq);
                    if (!phoneRegex.test(phone.value.trim())) { show(phoneInvalid); phone.classList.add('is-invalid'); ok = false; } else { hide(phoneInvalid); phone.classList.remove('is-invalid'); }
                }

                const dobReq = dob ? dob.parentElement.querySelector('.required-error') : null;
                const dobInvalid = dob ? dob.parentElement.querySelector('.dob-invalid-error') : null;
                if (!dob || !dob.value) { show(dobReq); hide(dobInvalid); dob && dob.classList.add('is-invalid'); ok = false; }
                else {
                    hide(dobReq);
                    const d = new Date(dob.value);
                    const today = new Date();
                    let age = today.getFullYear() - d.getFullYear();
                    const m = today.getMonth() - d.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
                    if (isNaN(d.getTime()) || age < 15) { show(dobInvalid); dob.classList.add('is-invalid'); ok = false; } else { hide(dobInvalid); dob.classList.remove('is-invalid'); }
                }

                return ok;
            }

            [firstName, lastName, phone, dob].forEach(inp => {
                if (!inp) return;
                inp.addEventListener('input', () => {
                    const req = inp.parentElement.querySelector('.required-error'); if (req) hide(req);
                    if (inp.name === 'PhoneNumber') { const inv = inp.parentElement.querySelector('.phone-invalid-error'); if (inv) hide(inv); }
                    if (inp.name === 'DateOfBirth') { const inv = inp.parentElement.querySelector('.dob-invalid-error'); if (inv) hide(inv); }
                    inp.classList.remove('is-invalid');
                });
            });

            profileForm.addEventListener('submit', function(e) {
                if (!validateProfile()) {
                    e.preventDefault();
                    const firstErr = profileForm.querySelector('.is-invalid') || profileForm.querySelector('.required-error:not(.d-none)');
                    if (firstErr) firstErr.focus();
                }
            });
        })();

        let mySkills = [];
        try {
            const rawData = document.getElementById('skillsInput').value;
            mySkills = rawData ? JSON.parse(rawData) : [];
        } catch (e) {
            console.error("Error parsing skills", e);
            mySkills = [];
        }

        const skillsContainer = document.getElementById('skillsContainer');
        const noSkillsMsg = document.getElementById('noSkillsMsg');
        const skillsInput = document.getElementById('skillsInput');
        const totalSkillScoreEl = document.getElementById('totalSkillScore');

        function renderSkills() {
            skillsContainer.innerHTML = '';
            
            if (mySkills.length === 0) {
                noSkillsMsg.style.display = 'block';
                totalSkillScoreEl.textContent = 0;
            } else {
                noSkillsMsg.style.display = 'none';
                let total = 0;
                mySkills.forEach((skill, index) => {
                    let badgeColor = 'badge-soft-primary';
                    if (skill.ProficiencyLevel === 'Expert') badgeColor = 'badge-soft-success';
                    if (skill.ProficiencyLevel === 'Beginner') badgeColor = 'badge-soft-secondary';

                    const popularity = (typeof skill.PopularityScore !== 'undefined') ? skill.PopularityScore : 0;
                    total += Number(popularity) || 0;

                    const html = `
                        <div class="d-inline-flex align-items-center bg-white border shadow-sm rounded-pill pr-2 pl-3 py-2 mr-2 mb-2 animate__animated animate__fadeIn">
                            <div class="mr-3">
                                <span class="font-weight-bold text-dark d-block" style="line-height:1.2">${skill.SkillName}</span>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    ${skill.ProficiencyLevel} • ${skill.YearOfExperience || 0} year(s)
                                </small>
                            </div>
                            <div class="mr-2 d-flex align-items-center">
                                        <span class="badge badge-primary" style="background-color:#007bff;color:#fff;">Popularity: ${popularity}</span>
                                    </div>
                            <button type="button" class="btn btn-sm btn-light text-danger rounded-circle" 
                                    onclick="removeSkill(${index})" style="width: 30px; height: 30px; padding: 0; display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    skillsContainer.insertAdjacentHTML('beforeend', html);
                });

                totalSkillScoreEl.textContent = Math.round(total);
            }
            
            skillsInput.value = JSON.stringify(mySkills);
        }

        document.getElementById('saveSkillBtn').addEventListener('click', function() {
            const name = document.getElementById('skillNameInput').value;
            const level = document.getElementById('skillLevelInput').value;
            const exp = document.getElementById('skillExpInput').value;

            if (!name) {
                alert("Please enter a skill name");
                return;
            }

            if (mySkills.some(s => s.SkillName.toLowerCase() === name.toLowerCase())) {
                alert("This skill is already added!");
                return;
            }

            mySkills.push({
                SkillName: name,
                ProficiencyLevel: level,
                YearOfExperience: parseFloat(exp) || 0
            });

            renderSkills();

            document.getElementById('skillForm').reset();
            $('#addSkillModal').modal('hide');
        });

        window.removeSkill = function(index) {
            if (confirm('Remove this skill?')) {
                mySkills.splice(index, 1);
                renderSkills();
            }
        };

        renderSkills();
    </script>
</body>