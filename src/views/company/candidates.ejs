<% // Data is passed from controller %>
    <%- include('../partials/header', { title: 'Quản lý Ứng viên' }) %>

        <body class="dashboard-page">
            <div class="dashboard-wrapper">

                <%- include('../partials/dashboard-sidebar', { activePage: 'candidates' }) %>

                    <main class="main-content">

                        <header class="dashboard-header">
                            <h5 class="mb-0 font-weight-bold text-dark">Candidates</h5>
                            <div class="d-flex align-items-center">
                                <div class="dropdown">
                                    <a href="#"
                                        class="d-flex align-items-center text-decoration-none text-dark dropdown-toggle"
                                        data-toggle="dropdown">
                                        <img src="<%= (typeof user !== 'undefined' && user.avatarUrl) ? user.avatarUrl : '/images/default-avatar.png' %>"
                                            class="rounded-circle mr-2" width="35" height="35"
                                            style="object-fit: cover; border: 1px solid #dee2e6;">
                                        <span class="font-weight-bold small mr-1">
                                            <%= (typeof user !=='undefined' && user.email) ? user.email.split('@')[0]
                                                : 'Company' %>
                                        </span>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right border-0 shadow-lg">
                                        <a class="dropdown-item" href="/">Back Home</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item text-danger" href="/auth/logout">Logout</a>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div class="p-4">

                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm p-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light p-3 rounded mr-3 text-primary">
                                                <i class="fas fa-users fa-lg"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0 text-muted">Total Candidates</h6>
                                                <h4 class="font-weight-bold mb-0">
                                                    <%= candidates ? candidates.length : 0 %>
                                                </h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <% if (candidates && candidates.length> 0) { %>
                                        <div class="custom-table-wrapper bg-white shadow-sm rounded-lg overflow-hidden">
                                            <table class="table custom-table table-hover mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="pl-4">Candidate</th>
                                                        <th>Applied For</th>
                                                        <th>Applied Date</th>
                                                        <th>Status</th>
                                                        <th class="text-right pr-4">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% candidates.forEach(candidate=> { %>
                                                        <tr>
                                                            <td class="pl-4 align-middle">
                                                                <div class="d-flex align-items-center">
                                                                    <img src="/images/default-avatar.png"
                                                                        alt="<%= candidate.SeekerName %>"
                                                                        class="rounded-circle mr-3 border"
                                                                        style="width: 40px; height: 40px; object-fit: cover;">
                                                                    <div>
                                                                        <h6 class="mb-0 font-weight-bold text-dark">
                                                                            <%= candidate.SeekerName %>
                                                                        </h6>
                                                                        <small class="text-muted">
                                                                            <%= candidate.SeekerEmail %>
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td class="align-middle">
                                                                <span class="text-dark font-weight-bold">
                                                                    <%= candidate.JobTitle %>
                                                                </span>
                                                            </td>
                                                            <td class="align-middle text-muted">
                                                                <%= new
                                                                    Date(candidate.ApplicationDate).toLocaleDateString()
                                                                    %>
                                                            </td>
                                                            <td class="align-middle">
                                                                <% let badgeClass='badge-secondary' ; if
                                                                    (candidate.ApplicationStatus==='Submitted' )
                                                                    badgeClass='badge-soft-info text-info' ; else if
                                                                    (candidate.ApplicationStatus==='UnderReview' )
                                                                    badgeClass='badge-soft-warning text-warning' ; else
                                                                    if (candidate.ApplicationStatus==='Interview' )
                                                                    badgeClass='badge-soft-primary text-primary' ; else
                                                                    if (candidate.ApplicationStatus==='Offer' )
                                                                    badgeClass='badge-soft-success text-success' ; else
                                                                    if (candidate.ApplicationStatus==='Rejected' )
                                                                    badgeClass='badge-soft-danger text-danger' ; %>
                                                                    <span class="badge <%= badgeClass %> px-3 py-2"
                                                                        style="font-size: 0.85rem;"
                                                                        id="status-<%= candidate.ApplicationID %>">
                                                                        <%= candidate.ApplicationStatus %>
                                                                    </span>
                                                                    <% if (candidate.ApplicationStatus==='Submitted' ) {
                                                                        %>
                                                                        <span
                                                                            class="badge badge-danger ml-1 shadow-sm animate__animated animate__flash animate__infinite">New</span>
                                                                        <% } %>
                                                            </td>
                                                            <td class="align-middle text-right pr-4">
                                                                <button
                                                                    class="btn btn-sm btn-outline-primary shadow-sm view-candidate-btn"
                                                                    data-id="<%= candidate.ApplicationID %>"
                                                                    data-status="<%= candidate.ApplicationStatus %>"
                                                                    data-toggle="modal"
                                                                    data-target="#candidateModal-<%= candidate.ApplicationID %>">
                                                                    <i class="far fa-eye mr-1"></i> View
                                                                </button>
                                                            </td>
                                                        </tr>

                                                        <div class="modal fade"
                                                            id="candidateModal-<%= candidate.ApplicationID %>"
                                                            tabindex="-1" role="dialog" aria-hidden="true">
                                                            <div class="modal-dialog modal-lg modal-dialog-centered"
                                                                role="document">
                                                                <div
                                                                    class="modal-content border-0 shadow-lg rounded-lg">
                                                                    <div class="modal-header border-0 pb-0">
                                                                        <button type="button" class="close"
                                                                            data-dismiss="modal" aria-label="Close">
                                                                            <span aria-hidden="true">&times;</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body p-5">
                                                                        <div class="text-center mb-4">
                                                                            <img src="/images/default-avatar.png"
                                                                                class="rounded-circle shadow-lg mb-3 border-white border"
                                                                                style="width: 120px; height: 120px; object-fit: cover; border-width: 4px !important;">
                                                                            <h3 class="font-weight-bold mb-1">
                                                                                <%= candidate.SeekerName %>
                                                                            </h3>
                                                                            <p
                                                                                class="text-primary font-weight-bold mb-0">
                                                                                <%= candidate.JobTitle %>
                                                                            </p>
                                                                            <p class="text-muted small">
                                                                                <%= candidate.SeekerEmail %>
                                                                            </p>
                                                                        </div>
                                                                        <div class="bg-light p-4 rounded-lg">
                                                                            <h6
                                                                                class="font-weight-bold text-uppercase text-muted small mb-3">
                                                                                Application Info</h6>
                                                                            <div class="row">
                                                                                <div class="col-6">
                                                                                    <small
                                                                                        class="text-muted d-block">Applied
                                                                                        Date</small>
                                                                                    <span
                                                                                        class="font-weight-bold text-dark">
                                                                                        <%= new
                                                                                            Date(candidate.ApplicationDate).toLocaleDateString()
                                                                                            %>
                                                                                    </span>
                                                                                </div>
                                                                                <div class="col-6">
                                                                                    <small
                                                                                        class="text-muted d-block">Current
                                                                                        Status</small>
                                                                                    <span
                                                                                        class="font-weight-bold text-dark">
                                                                                        <%= candidate.ApplicationStatus
                                                                                            %>
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div
                                                                        class="modal-footer border-0 bg-light rounded-bottom p-4">
                                                                        <button type="button"
                                                                            class="btn btn-light font-weight-bold"
                                                                            data-dismiss="modal">Close</button>
                                                                        <a href="mailto:<%= candidate.SeekerEmail %>"
                                                                            class="btn btn-primary-modern shadow-sm"><i
                                                                                class="fas fa-envelope mr-2"></i>
                                                                            Contact Candidate</a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }) %>
                                                </tbody>
                                            </table>
                                        </div>
                                        <% } else { %>
                                            <div class="text-center py-5">
                                                <img src="/images/empty-state.svg" alt="No Candidates" class="mb-4"
                                                    style="max-width: 200px; opacity: 0.5;">
                                                <h4>No candidates yet</h4>
                                                <p class="text-muted mb-4">Your job postings haven't received any
                                                    applications yet.</p>
                                            </div>
                                            <% } %>
                                </div>
                            </div>
                        </div>
                    </main>
            </div>

            <%- include('../partials/footer') %>

                <script>
                    $(document).ready(function () {
                        $('.view-candidate-btn').click(function () {
                            const appId = $(this).data('id');
                            const status = $(this).data('status');
                            if (status === 'Submitted') {
                                $.ajax({
                                    url: '/company/applications/' + appId + '/status',
                                    type: 'POST',
                                    data: { status: 'UnderReview' },
                                    success: function (response) {
                                        $('#status-' + appId).text('UnderReview')
                                            .removeClass('badge-soft-info text-info')
                                            .addClass('badge-soft-warning text-warning');
                                        $('.view-candidate-btn[data-id="' + appId + '"]').closest('td').prev().find('.badge-danger').remove();
                                    },
                                    error: function (err) {
                                        console.error('Error updating status:', err);
                                    }
                                });
                            }
                        });
                    });
                </script>